<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üìö Classwork & To-Do Reminder</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    :root {
      --bg1:#6a11cb; --bg2:#2575fc;
      --panel:rgba(255,255,255,0.1);
      --accent:#ffd166; --danger:#ff6961;
    }
    * { box-sizing:border-box; }
    body {
      margin:0; font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff; min-height:100vh;
      display:flex; flex-direction:column; align-items:center;
      padding:20px;
    }
    header {
      text-align:center; margin-bottom:20px;
    }
    header h1 {
      font-size:24px; margin:0; font-weight:600;
    }
    .container { width:100%; max-width:900px; }

    .panel {
      background:var(--panel);
      border-radius:12px;
      padding:16px; margin-bottom:16px;
      box-shadow:0 6px 16px rgba(0,0,0,0.25);
    }
    .small { font-size:13px; opacity:0.85; }

    /* subjects / reminders */
    ul.plain { list-style:none; padding:0; margin:12px 0; }
    li.item {
      background:rgba(255,255,255,0.06);
      border-radius:8px;
      padding:10px 12px;
      margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px;
    }
    .subject-left { flex:1; display:flex; flex-direction:column; gap:6px; }
    .subject-line { font-weight:600; font-size:15px; }
    .subject-detail { font-size:14px; opacity:0.9; }
    .images-row { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
    .images-row img {
      width:84px; height:64px; object-fit:cover;
      border-radius:6px; cursor:pointer;
    }

    /* buttons / inputs */
    input, textarea {
      width:100%; padding:10px; margin-top:6px;
      border:none; border-radius:8px;
      background:rgba(255,255,255,0.08); color:#fff;
    }
    textarea { min-height:70px; resize:vertical; }
    .btn {
      background:var(--accent); color:#222;
      border:none; border-radius:8px;
      padding:8px 14px; font-weight:600; cursor:pointer;
    }
    .btn-danger { background:var(--danger); color:#fff; }
    .hidden { display:none!important; }

    /* responsive */
    @media(max-width:600px){
      .images-row img { width:48%; height:100px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìö Classwork & To-Do Reminder</h1>
    <div style="margin-top:8px;">
      <button class="btn" onclick="toggleLogin()">üîë Admin Login</button>
      <button class="btn btn-danger hidden" id="logoutBtn" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="container">
    <!-- Subjects -->
    <section class="panel" id="subjectsPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-size:14px;opacity:0.9">SUBJECTS NEED TO DO</div>
          <div class="small">Shows status per subject</div>
        </div>
        <div class="small" id="subjectsCount">0</div>
      </div>
      <ul id="subjectsList" class="plain"></ul>
    </section>

    <!-- Reminders -->
    <section class="panel" id="remindersPanel">
      <div style="font-size:14px;opacity:0.9;margin-bottom:4px">EXTRA / REMINDERS</div>
      <div class="small">Examples: Bring a hat for the event tomorrow.</div>
      <ul id="remindersList" class="plain"></ul>
    </section>

    <!-- Admin Login -->
    <section class="panel hidden" id="loginPanel">
      <div id="loginForm">
        <div style="font-weight:600;margin-bottom:8px">üîë Admin Login (only admin needs to login)</div>
        <input id="email" type="email" placeholder="admin email" />
        <input id="password" type="password" placeholder="password" />
        <button class="btn" id="loginBtn" style="margin-top:10px">Login as Admin</button>
        <div class="small" id="loginStatus"></div>
      </div>

      <div id="adminPanel" class="hidden" style="margin-top:16px">
        <div style="font-weight:700;margin-bottom:8px">‚öôÔ∏è Admin Panel</div>

        <!-- Add Subject -->
        <form id="addSubjectForm">
          <input id="subjectName" type="text" placeholder="Subject e.g. SCIENCE" required />
          <input id="subjectTask" type="text" placeholder="Task e.g. Assignment" required />
          <input id="subjectDue" type="text" placeholder="Due (Tomorrow, Tuesday) optional" />
          <input id="subjectFiles" type="file" multiple accept="image/*" />
          <button class="btn" type="submit" style="margin-top:8px">‚ûï Add Subject</button>
          <div class="small" id="subjectFormMsg"></div>
        </form>

        <hr style="margin:14px 0;opacity:0.2" />

        <!-- Add Reminder -->
        <form id="addReminderForm">
          <textarea id="reminderText" placeholder="Reminder text..." required></textarea>
          <input id="reminderFiles" type="file" multiple accept="image/*" />
          <button class="btn" type="submit" style="margin-top:8px">‚ûï Add Reminder</button>
          <div class="small" id="reminderFormMsg"></div>
        </form>
      </div>
    </section>

    <!-- Debug -->
    <section class="panel" id="debugPanel">
      <div style="font-weight:600">Debug / Status</div>
      <pre id="debugLog" style="white-space:pre-wrap;max-height:200px;overflow:auto;font-size:12px;"></pre>
    </section>
  </main>

  <script>
  // ================= CONFIG =================
  const SUPABASE_URL = "https://mwosezbzzxjzpgxsdpdr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13b3NlemJ6enhqenBneHNkcGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjk5ODQsImV4cCI6MjA3MzYwNTk4NH0.LzE9RoKMx9zsMdqydL1vSNeUCNlpD2izQMNCrqiAeCk";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM elements
  const subjectsList = document.getElementById('subjectsList');
  const remindersList = document.getElementById('remindersList');
  const subjectsCount = document.getElementById('subjectsCount');
  const loginPanel = document.getElementById('loginPanel');
  const loginBtn = document.getElementById('loginBtn');
  const loginStatus = document.getElementById('loginStatus');
  const adminPanel = document.getElementById('adminPanel');
  const logoutBtn = document.getElementById('logoutBtn');
  const subjectFormMsg = document.getElementById('subjectFormMsg');
  const reminderFormMsg = document.getElementById('reminderFormMsg');
  const debugLog = document.getElementById('debugLog');

  let isAdmin = false;

  // log helper
  function log(...args) {
    console.log(...args);
    debugLog.textContent += args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : a)).join(" ") + "\n";
    debugLog.scrollTop = debugLog.scrollHeight;
  }

  // toggle login panel
  function toggleLogin() {
    loginPanel.classList.toggle('hidden');
  }

  // ---------- Load data ----------
  async function loadData() {
    try {
      subjectsList.innerHTML = '';
      remindersList.innerHTML = '';
      log("Loading data...");

      // subjects
      const { data: subjects, error: sErr } = await supabase
        .from('subjects').select('*').order('id', { ascending:true });
      if (sErr) throw sErr;

      subjectsCount.textContent = subjects.length;
      subjects.forEach(s => {
        const li = document.createElement('li');
        li.className = 'item';
        const left = document.createElement('div');
        left.className = 'subject-left';

        const line = document.createElement('div');
        line.className = 'subject-line';
        line.textContent = `${s.name} [ ${s.task} | ${s.due || 'No'} ]`;
        left.appendChild(line);

        if (s.images && s.images.length) {
          const imgRow = document.createElement('div');
          imgRow.className = 'images-row';
          s.images.forEach(url=>{
            const img = document.createElement('img');
            img.src = url;
            img.onclick=()=>window.open(url,'_blank');
            imgRow.appendChild(img);
          });
          left.appendChild(imgRow);
        }
        li.appendChild(left);

        if (isAdmin) {
          const del = document.createElement('button');
          del.className = 'btn btn-danger';
          del.textContent = "‚ùå";
          del.onclick=()=>deleteSubject(s.id);
          li.appendChild(del);
        }
        subjectsList.appendChild(li);
      });

      // reminders
      const { data: reminders, error: rErr } = await supabase
        .from('reminders').select('*').order('id', { ascending:true });
      if (rErr) throw rErr;

      reminders.forEach(r => {
        const li = document.createElement('li');
        li.className = 'item';
        const left = document.createElement('div');
        left.className = 'subject-left';
        const line = document.createElement('div');
        line.className = 'subject-line';
        line.textContent = r.text;
        left.appendChild(line);

        if (r.images && r.images.length) {
          const imgRow = document.createElement('div');
          imgRow.className = 'images-row';
          r.images.forEach(url=>{
            const img = document.createElement('img');
            img.src=url; img.onclick=()=>window.open(url,'_blank');
            imgRow.appendChild(img);
          });
          left.appendChild(imgRow);
        }
        li.appendChild(left);

        if (isAdmin) {
          const del = document.createElement('button');
          del.className='btn btn-danger';
          del.textContent="‚ùå";
          del.onclick=()=>deleteReminder(r.id);
          li.appendChild(del);
        }
        remindersList.appendChild(li);
      });
    } catch (err) {
      log("loadData error:", err.message || err);
    }
  }

  // ---------- Upload files ----------
  async function uploadFiles(files) {
    const urls=[];
    for (const file of files) {
      const path=`uploads/${Date.now()}-${file.name}`;
      const { data, error } = await supabase.storage.from('uploads').upload(path, file);
      if (error) { log("Upload error", error); continue; }
      const { data:pub } = await supabase.storage.from('uploads').getPublicUrl(data.path);
      urls.push(pub.publicUrl);
    }
    return urls;
  }

  // ---------- Add subject ----------
  document.getElementById('addSubjectForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const name=document.getElementById('subjectName').value;
    const task=document.getElementById('subjectTask').value;
    const due=document.getElementById('subjectDue').value;
    const files=document.getElementById('subjectFiles').files;
    const urls=await uploadFiles(files);
    const { error } = await supabase.from('subjects').insert([{ name, task, due, images:urls }]);
    subjectFormMsg.textContent= error? "Error: "+error.message:"Added!";
    await loadData();
    e.target.reset();
  });

  // ---------- Add reminder ----------
  document.getElementById('addReminderForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const text=document.getElementById('reminderText').value;
    const files=document.getElementById('reminderFiles').files;
    const urls=await uploadFiles(files);
    const { error } = await supabase.from('reminders').insert([{ text, images:urls }]);
    reminderFormMsg.textContent= error? "Error: "+error.message:"Added!";
    await loadData();
    e.target.reset();
  });

  // ---------- Delete ----------
  async function deleteSubject(id){
    await supabase.from('subjects').delete().eq('id',id);
    loadData();
  }
  async function deleteReminder(id){
    await supabase.from('reminders').delete().eq('id',id);
    loadData();
  }

  // ---------- Auth ----------
  loginBtn.addEventListener('click', async ()=>{
    loginStatus.textContent="Logging in...";
    const email=document.getElementById('email').value;
    const password=document.getElementById('password').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error){ loginStatus.textContent="Error: "+error.message; return; }
    isAdmin=true;
    adminPanel.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    loginStatus.textContent="Logged in!";
    loadData();
  });

  async function logout(){
    await supabase.auth.signOut();
    isAdmin=false;
    adminPanel.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    loginPanel.classList.add('hidden');
    loadData();
  }

  // initial
  loadData();
  </script>
</body>
</html>
